{{#options}}
  <label>
    <input type="checkbox" 
    name="{{id}}[]" 
    value="{{codeItem}}"
    data-has-sub="{{hasSubQuestions}}"
    {{#isSelected}}checked{{/isSelected}}
    data-requires-precision="{{requiresPrecision}}"
    data-precision-key="{{precisionKey}}"
    data-exclusive="{{exclusive}}">
    {{label}}
  </label>

 {{#requiresPrecision}}
    {{> partials/precision }}
  {{/requiresPrecision}}

  {{#hasSubQuestions}}
   <div class="sub-questions"
    data-parent="{{codeItem}}"
    style="{{^showSubQuestions}}display:none;{{/showSubQuestions}}">
  
  {{#subQuestions}}
    {{> partials/accQuestion}}
  {{/subQuestions}}

</div>
{{/hasSubQuestions}}

{{/options}}
<script>
document.addEventListener('DOMContentLoaded', function () {

  const checkboxes = document.querySelectorAll(
    'input[type=checkbox][name="{{id}}[]"]'
  );

  function hidePrecision(id, value) {
    const input = document.querySelector(
      `input[name="precision_${id}_${value}"]`
    );
    if (input) input.style.display = 'none';
  }

  checkboxes.forEach(cb => {
    cb.addEventListener('change', function () {

      const isExclusive = this.dataset.exclusive === 'true';

      /* ---------- Sous-questions ---------- */
      const subQ = document.querySelector(
        `.sub-questions[data-parent="${this.value}"]`
      );
      if (subQ) subQ.style.display = this.checked ? 'block' : 'none';

      /* ----------  option exclusive cochée ---------- */
      if (isExclusive && this.checked) {
        checkboxes.forEach(other => {
          if (other === this) return;

          other.checked = false;
          other.disabled = true;

          hidePrecision('{{id}}', other.value);

          const otherSub = document.querySelector(
            `.sub-questions[data-parent="${other.value}"]`
          );
          if (otherSub) otherSub.style.display = 'none';
        });
      }

      /* ----------  option exclusive décochée ---------- */
      if (isExclusive && !this.checked) {
        checkboxes.forEach(other => {
          if (other !== this) {
            other.disabled = false;
          }
        });
      }

      /* ----------  option NON exclusive cochée ---------- */
      if (!isExclusive && this.checked) {
        checkboxes.forEach(other => {
          if (other.dataset.exclusive === 'true') {
            other.checked = false;
            other.disabled = true;
            hidePrecision('{{id}}', other.value);
          }
        });
      }

      /* ----------  aucune option exclusive sélectionnée ---------- */
      const hasExclusiveChecked = [...checkboxes].some(
        c => c.dataset.exclusive === 'true' && c.checked
      );

      if (!hasExclusiveChecked) {
        checkboxes.forEach(c => c.disabled = false);
      }
    });
/* ================== RÉINITIALISATION EXCLUSIVE AU CHARGEMENT ================== */

const exclusiveChecked = [...checkboxes].find(
  cb => cb.dataset.exclusive === 'true' && cb.checked
);

if (exclusiveChecked) {
  checkboxes.forEach(other => {
    if (other === exclusiveChecked) return;

    other.checked = false;
    other.disabled = true;

    // masquer précision
    hidePrecision('{{id}}', other.value);

    // masquer sous-questions
    const otherSub = document.querySelector(
      `.sub-questions[data-parent="${other.value}"]`
    );
    if (otherSub) otherSub.style.display = 'none';
  });
}

    /* ---------- Initialisation (reload page) ---------- */
    if (cb.checked) {
      const subQ = document.querySelector(
        `.sub-questions[data-parent="${cb.value}"]`
      );
      if (subQ) subQ.style.display = 'block';
    }
  });
});
</script>
